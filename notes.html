<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>3DVR Notes</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #f4f6f9;
  color: #444;
  margin: 0;
  padding: 0;
}

.container {
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 280px;
  background: #fbfbfb;
  border-right: 1px solid #ddd;
  overflow-y: auto;
  padding: 10px;
}

.main {
  flex: 1;
  background: white;
  display: flex;
  flex-direction: column;
}

.breadcrumb-bar {
  position: sticky;
  top: 0;
  background: #fff;
  border-bottom: 1px solid #ddd;
  padding: 10px 16px;
  z-index: 10;
}

.breadcrumb-bar span {
  cursor: pointer;
  color: #3498db;
}

.breadcrumb-bar span:hover {
  text-decoration: underline;
}

.breadcrumb-bar span:not(:last-child)::after {
  content: " / ";
}

.content {
  flex: 1;
  padding: 20px;
}

.content textarea {
  width: 100%;
  height: 100%;
  border: none;
  resize: none;
  font-size: 1rem;
  font-family: inherit;
}

ul {
  list-style: none;
  padding-left: 0;
}

.item-row {
  padding: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  border-radius: 6px;
}

.item-row:hover {
  background: #f0f0f0;
}

.item-row.active {
  background: #dfefff;
}

.toggle {
  width: 20px;
}

.delete-btn {
  margin-left: auto;
  color: #e74c3c;
  font-size: 0.85rem;
  visibility: hidden;
}

.item-row:hover .delete-btn {
  visibility: visible;
}

.add-controls {
  padding: 6px 10px;
  color: #666;
  font-size: 0.9rem;
}

.add-controls span {
  cursor: pointer;
  margin-right: 10px;
}

.add-controls span:hover {
  text-decoration: underline;
}

.new-item-input {
  display: none;
  padding: 4px;
  margin-top: 4px;
  width: 95%;
}

.children {
  padding-left: 20px;
}
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <ul id="tree"></ul>
  </div>

  <div class="main">
    <div class="breadcrumb-bar" id="breadcrumb"></div>
    <div class="content">
      <textarea id="note-content" placeholder="Select a note to view it..."></textarea>
    </div>
  </div>
</div>
<script>
const gun = Gun(['https://peer.wallie.io/gun']);
const root = gun.get('root');
const items = {};

let currentOpenNoteId = null;
let currentOpenNoteParent = null;

function makeId() {
  return 'id_' + Math.random().toString(36).substr(2, 6) + Date.now().toString(36);
}

function createListItem(item) {
  const li = document.createElement('li');
  li.setAttribute('data-id', item.id);
  li.setAttribute('data-type', item.type);

  const row = document.createElement('div');
  row.className = 'item-row';

  const toggle = document.createElement('span');
  toggle.className = 'toggle';
  toggle.textContent = item.type === 'folder' ? 'â–¶' : '';
  row.appendChild(toggle);

  const titleSpan = document.createElement('span');
  titleSpan.textContent = item.title;
  row.appendChild(titleSpan);

  const delBtn = document.createElement('span');
  delBtn.className = 'delete-btn';
  delBtn.textContent = 'ðŸ—‘';
  row.appendChild(delBtn);

  li.appendChild(row);

  if (item.type === 'folder') {
    const childrenUl = document.createElement('ul');
    childrenUl.className = 'children';
    childrenUl.style.display = 'none';
    li.appendChild(childrenUl);

    const addLi = createAddControls(item.id);
    childrenUl.appendChild(addLi);
  }

  if (item.type === 'folder') {
    toggle.addEventListener('click', () => toggleFolder(li));
    titleSpan.addEventListener('click', () => toggleFolder(li));
  }

  if (item.type === 'note') {
    row.addEventListener('click', () => openNote(item.id));
  }

  titleSpan.addEventListener('dblclick', () => enableTitleEditing(titleSpan, item.id));
  delBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    deleteItem(item.id);
  });

  return li;
}
function createAddControls(parentId) {
  const li = document.createElement('li');
  li.className = 'add-controls';

  const addNote = document.createElement('span');
  addNote.textContent = '+ New Note';
  const addFolder = document.createElement('span');
  addFolder.textContent = '+ New Folder';

  const input = document.createElement('input');
  input.className = 'new-item-input';
  input.placeholder = 'Enter title and press Enter';

  li.appendChild(addNote);
  li.appendChild(addFolder);
  li.appendChild(input);

  let typeToAdd = null;

  function showInput(type) {
    typeToAdd = type;
    input.style.display = '';
    input.focus();
    addNote.style.display = 'none';
    addFolder.style.display = 'none';
  }

  function hideInput() {
    input.value = '';
    input.style.display = 'none';
    addNote.style.display = '';
    addFolder.style.display = '';
  }

  function createItem() {
    const title = input.value.trim();
    if (!title) {
      hideInput();
      return;
    }

    const id = makeId();
    const newItem = {
      id, title, type: typeToAdd, parent: parentId
    };

    if (typeToAdd === 'note') newItem.content = "";

    const parentNode = parentId === 'root' ? root : gun.get(parentId);
    parentNode.get('children').get(id).put(newItem);

    hideInput();
  }

  addNote.onclick = () => showInput('note');
  addFolder.onclick = () => showInput('folder');

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') createItem();
    if (e.key === 'Escape') hideInput();
  });
  input.addEventListener('blur', hideInput);

  return li;
}

function toggleFolder(li) {
  const children = li.querySelector('.children');
  const toggle = li.querySelector('.toggle');
  const expanded = children.style.display !== 'none';

  if (expanded) {
    children.style.display = 'none';
    toggle.textContent = 'â–¶';
  } else {
    children.style.display = 'block';
    toggle.textContent = 'â–¼';

    if (!li.dataset.loaded) {
      li.dataset.loaded = 'true';
      gun.get(li.dataset.id).get('children').map().once((data, key) => {
        if (!data || !data.title) return;
        items[key] = data;
        const childLi = createListItem(data);
        children.insertBefore(childLi, children.querySelector('.add-controls'));
      });
    }
  }
}

function openNote(id) {
  const note = items[id];
  if (!note) return;

  document.querySelectorAll('.item-row.active').forEach(el => el.classList.remove('active'));
  const row = document.querySelector(`li[data-id="${id}"] .item-row`);
  if (row) row.classList.add('active');

  const crumb = document.getElementById('breadcrumb');
  crumb.innerHTML = "";
  getPath(id).forEach(p => {
    const span = document.createElement('span');
    span.textContent = p.title || "Home";
    crumb.appendChild(span);
  });

  const textarea = document.getElementById('note-content');
  textarea.value = note.content || "";
  textarea.disabled = false;

  currentOpenNoteId = id;
  currentOpenNoteParent = note.parent;
}

function getPath(id) {
  const path = [];
  while (id && id !== 'root') {
    const item = items[id];
    if (!item) break;
    path.unshift(item);
    id = item.parent || 'root';
  }
  path.unshift({ id: 'root', title: 'Home' });
  return path;
}

function enableTitleEditing(el, id) {
  const original = el.textContent;
  el.setAttribute('contenteditable', 'true');
  el.focus();

  function finish(save) {
    el.removeAttribute('contenteditable');
    el.removeEventListener('blur', onBlur);
    el.removeEventListener('keydown', onKey);
    if (save) {
      const newTitle = el.textContent.trim() || original;
      el.textContent = newTitle;
      const item = items[id];
      if (item && newTitle !== item.title) {
        item.title = newTitle;
        const parent = item.parent === 'root' ? root : gun.get(item.parent);
        parent.get('children').get(id).get('title').put(newTitle);
      }
    } else {
      el.textContent = original;
    }
  }

  function onBlur() { finish(true); }
  function onKey(e) {
    if (e.key === 'Enter') finish(true);
    if (e.key === 'Escape') finish(false);
  }

  el.addEventListener('blur', onBlur);
  el.addEventListener('keydown', onKey);
}

function deleteItem(id) {
  const item = items[id];
  if (!item) return;

  const parent = item.parent === 'root' ? root : gun.get(item.parent);
  parent.get('children').get(id).put(null);

  const li = document.querySelector(`li[data-id="${id}"]`);
  if (li) li.remove();

  if (item.type === 'folder') {
    gun.get(id).get('children').map().once((data, key) => {
      if (data) deleteItem(key);
    });
  }

  if (id === currentOpenNoteId) {
    document.getElementById('note-content').value = "";
    currentOpenNoteId = null;
    document.getElementById('breadcrumb').innerHTML = "";
  }

  delete items[id];
}

document.getElementById('note-content').addEventListener('input', () => {
  if (!currentOpenNoteId) return;
  const content = document.getElementById('note-content').value;
  const parent = currentOpenNoteParent === 'root' ? root : gun.get(currentOpenNoteParent);
  parent.get('children').get(currentOpenNoteId).get('content').put(content);
});

function renderTree() {
  const ul = document.getElementById('tree');
  ul.innerHTML = "";
  const addLi = createAddControls('root');
  root.get('children').map().once((data, key) => {
    if (!data || !data.title) return;
    items[key] = data;
    ul.appendChild(createListItem(data));
  });
  ul.appendChild(addLi);
}

renderTree();
</script>
</body>
</html>
