<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3DVR Notes</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f6f9; color: #333; }
.sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; }
.main { flex: 1; display: flex; flex-direction: column; }
.main textarea { flex: 1; font-size: 1rem; padding: 20px; border: none; outline: none; }
h2 { margin-top: 0; }
ul { list-style: none; padding: 0; }
li { padding: 6px; border-radius: 4px; cursor: pointer; }
li:hover { background: #eee; }
li.active { background: #dfefff; }
.delete { color: red; float: right; cursor: pointer; }
input[type=text] { width: 100%; padding: 6px; margin: 6px 0; box-sizing: border-box; }
.editable { display: inline-block; }
.editable[contenteditable="true"] { background: #fff9c4; padding: 2px 4px; }
a { color: #333; text-decoration: underline; display: block; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="sidebar">
  <a href="index.html">&larr; Back to Portal</a>
  <h2>📂 Folders</h2>
  <input type="text" id="new-folder" placeholder="Add Folder + Enter">
  <ul id="folders"></ul>

  <h2>📝 Notes</h2>
  <input type="text" id="new-note" placeholder="Add Note + Enter" disabled>
  <ul id="notes"></ul>
</div>

<div class="main">
  <h2 style="padding: 10px;" id="note-title">Select a note...</h2>
  <textarea id="note-content" placeholder="Note content..." disabled></textarea>
</div>

<script>
const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
const folders = gun.get('simple-folders');
const notes = gun.get('simple-notes');
let currentFolder = null;
let currentNoteId = null;

folders.map().on((folder, id) => {
  if (!folder) { document.getElementById(id)?.remove(); return; }
  let li = document.getElementById(id) || document.createElement('li');
  li.id = id;
  li.onclick = () => selectFolder(id);
  li.innerHTML = `<span class="editable">${folder.name}</span> <span class="delete">🗑</span>`;
  li.querySelector('.delete').onclick = (e) => { e.stopPropagation(); folders.get(id).put(null); };
  li.querySelector('.editable').ondblclick = () => enableEdit(li.querySelector('.editable'), newName => folders.get(id).put({ name: newName }));
  if (!document.getElementById(id)) document.getElementById('folders').appendChild(li);
});

document.getElementById('new-folder').addEventListener('keydown', e => {
  if (e.key === 'Enter') { folders.set({ name: e.target.value.trim() }); e.target.value = ''; }
});

function selectFolder(id) {
  currentFolder = id;
  document.getElementById('new-note').disabled = false;
  document.querySelectorAll('#folders li').forEach(li => li.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  renderNotes();
}

function renderNotes() {
  const ul = document.getElementById('notes'); ul.innerHTML = '';
  notes.map().once((note, id) => {
    if (!note || note.folder !== currentFolder) return;
    const li = document.createElement('li');
    li.innerHTML = `<span class="editable">${note.title}</span> <span class="delete">🗑</span>`;
    li.onclick = () => openNote(id);
    li.querySelector('.delete').onclick = (e) => { e.stopPropagation(); notes.get(id).put(null); };
    li.querySelector('.editable').ondblclick = () => enableEdit(li.querySelector('.editable'), newTitle => notes.get(id).put({ title: newTitle }));
    ul.appendChild(li);
  });
}

document.getElementById('new-note').addEventListener('keydown', e => {
  if (e.key === 'Enter') { notes.set({ title: e.target.value.trim(), folder: currentFolder, content: "" }); e.target.value = ''; }
});

function openNote(id) {
  currentNoteId = id;
  notes.get(id).once(note => {
    document.getElementById('note-title').textContent = note.title;
    document.getElementById('note-content').value = note.content || '';
    document.getElementById('note-content').disabled = false;
  });
}

document.getElementById('note-content').addEventListener('input', () => {
  if (currentNoteId) notes.get(currentNoteId).get('content').put(document.getElementById('note-content').value);
});

function enableEdit(el, callback) {
  el.setAttribute('contenteditable', 'true'); el.focus();
  const done = save => { el.removeAttribute('contenteditable'); if (save) callback(el.textContent.trim()); };
  el.addEventListener('blur', () => done(true), { once: true });
  el.addEventListener('keydown', e => { if (e.key === 'Enter') done(true); if (e.key === 'Escape') done(false); });
}
</script>
</body>
</html>
