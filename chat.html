<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3DVR - Group Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    /* Same styling you already had */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, #003366, #001a33);
      color: gold;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    /* ... */
  </style>
</head>
<body>

<a href="index.html">&larr; Back to Portal</a>
<h1>Group Chat</h1>

<div id="new-message">
  <input type="text" id="message-input" placeholder="Type your message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<div id="messages"></div>

<script>
  const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
  const chat = gun.get('3dvr-chat');

  // User handling
  const userId = localStorage.getItem('userId') || (() => {
    const id = 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('userId', id);
    return id;
  })();
  const user = gun.get('3dvr-users').get(userId);

  function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text) return;

    // Save the message
    chat.set({
      text,
      sender: userId,
      createdAt: Date.now()
    });

    input.value = '';

    // Increase user score
    user.get('score').once(currentScore => {
      const newScore = (currentScore || 0) + 1;
      user.get('score').put(newScore);
    });
  }

  const messages = {};

  function displayMessages() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '';

    // Sort by createdAt
    const sorted = Object.entries(messages)
      .sort(([, a], [, b]) => (a.createdAt || 0) - (b.createdAt || 0));

    for (const [id, message] of sorted) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message';
      msgDiv.id = id;
      
      const username = message.username || (message.sender || 'Anonymous');
      msgDiv.innerHTML = `<strong>${username}:</strong> ${message.text}`;
      messagesDiv.appendChild(msgDiv);
    }

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  chat.map().on((message, id) => {
    if (!message || messages[id]) return;

    // Fetch username if available
    if (message.sender) {
      gun.get('3dvr-users').get(message.sender).get('username').once(name => {
        message.username = name || message.sender; // fallback if no username
        messages[id] = message;
        displayMessages();
      });
    } else {
      messages[id] = message;
      displayMessages();
    }
  });
</script>

</body>
</html>
