<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3DVR - Group Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body {
      background: #e9f0f5;
      color: #222;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 2.4rem;
      margin-top: 0;
    }
    .top-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .top-buttons a {
      background: #66c2b0;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    .top-buttons a:hover {
      background: #5ca0d3;
    }
    #profile {
      background: #ffffff;
      border-radius: 12px;
      padding: 30px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
    }
    #profile p {
      margin: 10px 0;
      font-size: 1.1rem;
    }
    input {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 80%;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border-radius: 8px;
      background: #66c2b0;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #5ca0d3;
    }
    .progress-bar {
      width: 100%;
      background-color: #eee;
      border-radius: 8px;
      margin-top: 20px;
      overflow: hidden;
    }
    .progress {
      height: 20px;
      background-color: #66c2b0;
      width: 0%;
      transition: width 0.5s ease;
    }
    .teaser {
      margin-top: 20px;
      color: #666;
      font-size: 0.9rem;
    }
    .reset-btn {
      margin-top: 20px;
      font-size: 0.8rem;
      background: none;
      border: none;
      color: #5ca0d3;
      text-decoration: underline;
      cursor: pointer;
    }
    .reset-btn:hover {
      color: #3498db;
    }
  </style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">üè† Portal Home</a>
  <a href="profile.html">üßë Profile</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">‚≠ê Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">üöÄ Contribute on GitHub</a>
</div>

<header>
  <h1>Group Chat</h1>
  <p>üí¨ You earn <strong>+1 point</strong> for every message you send!</p>
</header>

<div id="profile-mini">
  <p><strong>Username:</strong> <span id="current-username">Loading...</span></p>
  <input type="text" id="new-username" placeholder="New username...">
  <button onclick="updateUsername()">Save</button>
</div>

<div id="room-select">
  <label for="room">Select Room:</label>
  <select id="room" onchange="changeRoom()">
    <option value="general">üåé General</option>
    <option value="ideas">üí° Ideas</option>
    <option value="support">üõü Support</option>
    <option value="random">üé≤ Random</option>
  </select>
</div>

<div id="new-message">
  <input type="text" id="message-input" placeholder="Type your message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<div id="messages"></div>

<footer>
  3DVR.Tech &copy; 2025 - Open Web for Everyone | Visit <a href="https://3dvr.tech">3DVR.Tech</a> | <a href="https://github.com/tmsteph/3dvr-portal">Contribute on GitHub</a>
</footer>

<script>
const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
let currentRoom = 'general';
let chat = gun.get('3dvr-chat').get(currentRoom);

const userId = localStorage.getItem('userId') || (() => {
  const id = 'user_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('userId', id);
  return id;
})();
const user = gun.get('3dvr-users').get(userId);

// Auto import old chats into General (only runs if in General and no messages exist)
if (currentRoom === 'general') {
  gun.get('3dvr-chat').map().once((message, id) => {
    if (!message) return;
    chat.get(id).once(existing => {
      if (!existing) {
        chat.get(id).put(message);
        console.log('Imported old message:', id);
      }
    });
  });
}

function updateUsername() {
  const name = document.getElementById('new-username').value.trim();
  if (name) {
    user.get('username').put(name);
    document.getElementById('new-username').value = '';
  }
}

user.get('username').on(name => {
  if (name) {
    document.getElementById('current-username').innerText = name;
  }
});

function sendMessage() {
  const input = document.getElementById('message-input');
  const text = input.value.trim();
  if (!text) return;

  chat.set({
    text,
    sender: userId,
    createdAt: Date.now()
  });

  input.value = '';

  user.get('score').once(currentScore => {
    const newScore = (currentScore || 0) + 1;
    user.get('score').put(newScore);
  });
}

const messages = {};

function timeAgoOrFullDate(timestamp) {
  const now = Date.now();
  const diff = Math.floor((now - timestamp) / 1000);
  if (diff < 60) return `${diff}s ago`;
  const mins = Math.floor(diff / 60);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const date = new Date(timestamp);
  return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function displayMessages() {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';

  const sorted = Object.entries(messages).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));
  for (const [id, message] of sorted) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.id = id;

    const username = message.username || (message.sender || 'Anonymous');
    const time = message.createdAt ? timeAgoOrFullDate(message.createdAt) : '';

    msgDiv.innerHTML = `<div><strong>${username}:</strong> ${message.text}</div><div class="meta">${time}</div>`;
    messagesDiv.appendChild(msgDiv);
  }
}

function loadRoom(roomName) {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  Object.keys(messages).forEach(key => delete messages[key]);

  chat = gun.get('3dvr-chat').get(roomName);
  chat.map().on((message, id) => {
    if (!message || messages[id]) return;

    if (message.sender) {
      gun.get('3dvr-users').get(message.sender).get('username').once(name => {
        message.username = name || message.sender;
        messages[id] = message;
        displayMessages();
      });
    } else {
      messages[id] = message;
      displayMessages();
    }
  });
}

function changeRoom() {
  currentRoom = document.getElementById('room').value;
  loadRoom(currentRoom);
}

loadRoom(currentRoom);
</script>

</body>
</html>
